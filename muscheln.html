<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Muscheljagd</title>
<style>
  /* Reset */
  *, *::before, *::after {
    margin: 0; padding: 0; box-sizing: border-box;
  }

  html, body {
    height: 100%;
    background-color: #a0f0e0;
    font-family: 'Futura', 'Segoe UI', sans-serif;
    color: #333;
  }

  body {
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 16px 8px 32px;
    min-height: 100vh;
  }

  h1#title-display {
    margin-bottom: 24px;
    font-weight: 900;
    font-size: 2.8rem;
    user-select: none;
  }

  /* Container mit Farb-Anzeige und Canvas nebeneinander */
  .game-container {
    display: flex;
    gap: 24px;
    width: 100%;
    max-width: 900px;
    justify-content: center;
    align-items: center;
    flex-wrap: nowrap;
  }

  /* Spieler-Farbanzeige - auf der linken Seite mit Hintergrund und Padding */
  #player-color-display {
    background-color: #dffff8;
    border-radius: 12px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.12);
    color: #333;
    font-size: 1.2rem;
    font-weight: 600;
    padding: 1em 1.5em;
    min-width: 160px;
    text-align: center;
    user-select: none;
  }
  #player-color-display span#color-name {
    font-weight: 700;
    font-size: 1.3rem;
    display: inline-block;
    margin-top: 0.25em;
    padding: 0.25em 0.8em;
    border-radius: 12px;
    box-shadow: inset 0 0 8px rgba(0,0,0,0.15);
  }

  /* Canvas Styling */
  canvas#canvas {
    background-color: #f4e3c1;
    border: 3px solid #fff;
    box-shadow: 0 0 28px rgba(0,0,0,0.22);
    cursor: pointer;
    display: block;
    max-width: 100%;
    height: auto;
    border-radius: 16px;
  }

  /* Controls und Info Bereich */
  .controls {
    margin-top: 24px;
  }

  button#clear-btn {
    font-family: 'Futura', 'Segoe UI', sans-serif;
    background-color: pink;
    color: #333;
    border: none;
    padding: 12px 28px;
    font-size: 1.1rem;
    border-radius: 10px;
    cursor: pointer;
    box-shadow: 0 4px 12px rgba(0,0,0,0.11);
    transition: background-color 0.3s ease, transform 0.2s ease;
    user-select: none;
  }
  button#clear-btn:hover {
    background-color: #ffb6c1;
    transform: scale(1.05);
  }

  #info-display {
    margin-top: 20px;
    font-size: 1.25rem;
    color: #333;
    user-select: none;
  }

  #info-display span {
    margin: 0 0.75em;
  }

  /* Responsive für kleinere Geräte */
  @media (max-width: 640px) {
    .game-container {
      flex-direction: column;
      max-width: 100%;
    }
    #player-color-display {
      min-width: auto;
      width: 100%;
      margin-bottom: 16px;
      font-size: 1.1rem;
      padding: 0.6em 1em;
    }
    #player-color-display span#color-name {
      font-size: 1.2rem;
      margin-top: 0.15em;
      padding: 0.2em 0.6em;
    }
    button#clear-btn {
      width: 100%;
      padding: 14px 0;
      font-size: 1.2rem;
    }
    canvas#canvas {
      width: 100% !important;
      height: auto !important;
    }
  }
</style>
</head>
<body>
  <h1 id="title-display">Muscheljagd</h1>

  <div class="game-container">
    <div id="player-color-display">
      Du bist Spieler:<br />
      <span id="color-name">...</span>
    </div>
    <canvas id="canvas" width="800" height="600" aria-label="Spielfläche"></canvas>
  </div>

  <div class="controls">
    <button id="clear-btn" aria-label="Spielbrett leeren">Clear Board</button>
  </div>

  <div id="info-display" aria-live="polite" aria-atomic="true">
    <span id="player-count">Spieler: 0</span> |
    <span id="shell-count">Muscheln: 0</span>
  </div>

<script>
  (() => {
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');
    const clearBtn = document.getElementById('clear-btn');
    const infoDisplay = document.getElementById('info-display');
    const playerCountDisplay = document.getElementById('player-count');
    const shellCountDisplay = document.getElementById('shell-count');
    const colorNameDisplay = document.getElementById('color-name');

    const canvasWidth = canvas.width;
    const canvasHeight = canvas.height;
    const backgroundColor = '#f4e3c1';

    const webSocketServer = 'wss://nosch.uber.space/web-rooms/';
    const socket = new WebSocket(webSocketServer);

    const playerColors = ['pink', 'black', 'lightblue', 'darkblue', 'white'];

    let shellCount = 0;
    let clientId = null;
    let clientCount = 0;
    let playerColor = null;

    // Zeigt Spielerzähler und Muschelzähler
    function updateCounters() {
      playerCountDisplay.textContent = `Spieler: ${clientCount}`;
      shellCountDisplay.textContent = `Muscheln: ${shellCount}`;
    }

    // Zeigt dem Spieler seine Farbe an
    function updatePlayerColorDisplay() {
      if (colorNameDisplay && playerColor) {
        colorNameDisplay.textContent = playerColor;
        // Farbtext anpassen: dunkle Farbe → weißer Text, sonst schwarzer Text
        colorNameDisplay.style.backgroundColor = playerColor;
        const darkColors = ['black', 'darkblue'];
        colorNameDisplay.style.color = darkColors.includes(playerColor.toLowerCase()) ? '#fff' : '#000';
        colorNameDisplay.style.padding = '0.3em 0.8em';
        colorNameDisplay.style.borderRadius = '12px';
        colorNameDisplay.style.fontWeight = '700';
      }
    }

    // Vergibt Farbe bei Vorliegen von clientId und clientCount
    function assignColorIfReady() {
      if (clientId !== null && clientCount !== null) {
        const index = (clientCount - 1) % playerColors.length;
        playerColor = playerColors[index];
        updatePlayerColorDisplay();
      }
    }

    // Canvas initial füllen
    function clearCanvas() {
      ctx.fillStyle = backgroundColor;
      ctx.fillRect(0, 0, canvasWidth, canvasHeight);
    }
    clearCanvas();

    // WebSocket Events
    socket.addEventListener('open', () => {
      socket.send(JSON.stringify(['*enter-room*', 'muschelraum']));
      socket.send(JSON.stringify(['*subscribe-client-count*']));
      setInterval(() => socket.send(''), 30000);
    });

    socket.addEventListener('message', (event) => {
      if (!event.data) return;
      let incoming;
      try {
        incoming = JSON.parse(event.data);
      } catch {
        return;
      }
      const type = incoming[0];

      switch(type) {
        case '*client-id*':
          clientId = incoming[1];
          assignColorIfReady();
          break;

        case '*client-count*':
          clientCount = incoming[1];
          updateCounters();
          assignColorIfReady();
          break;

        case 'draw-shell':
          {
            const [_, drawX, drawY, color] = incoming;
            ctx.fillStyle = color;
            ctx.beginPath();
            if(typeof ctx.roundRect === 'function'){
              ctx.roundRect(drawX, drawY, 10, 10, 5);
            } else {
              ctx.rect(drawX, drawY, 10, 10);
            }
            ctx.fill();
          }
          break;

        case '*error*':
          console.warn('Server-Fehler:', ...incoming[1]);
          break;
      }
    });

    socket.addEventListener('close', () => {
      if(infoDisplay){
        infoDisplay.textContent = 'Verbindung getrennt';
      }
    });

    // Klick auf Canvas - Muschel zeichnen und senden
    canvas.addEventListener('click', (e) => {
      const rect = canvas.getBoundingClientRect();
      const clickX = (e.clientX - rect.left);
      const clickY = (e.clientY - rect.top);

      const size = 10;
      const x = clickX - size / 2;
      const y = clickY - size / 2;

      ctx.fillStyle = playerColor || 'pink';
      ctx.beginPath();
      if(typeof ctx.roundRect === 'function'){
        ctx.roundRect(x, y, size, size, size / 2);
      } else {
        ctx.rect(x, y, size, size);
      }
      ctx.fill();

      shellCount++;
      updateCounters();

      socket.send(JSON.stringify(['*broadcast-message*', ['draw-shell', x, y, playerColor]]));
    });

    clearBtn.addEventListener('click', () => {
      clearCanvas();
      shellCount = 0;
      updateCounters();
    });
  })();
</script>
</body>
</html>
